{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Поставщик откликнуться</title>
    <link
      rel="shortcut icon"
      href="{% static 'assets/todotodo_logo.png' %}"
      type="image/x-icon"
    />
    <link rel="stylesheet" href="{% static 'response.css' %}" />
    <link rel="stylesheet" href="{% static 'multiselect.css' %}">
  </head>
  <body>
    <div class="layout dealer">
      <aside>
        <div class="hamb" id="hamb">
          <div class="hamb__field" id="hamb">
            <span class="bar"></span>
            <span class="bar"></span>
            <span class="bar"></span>
          </div>
        </div>
        <div class="top">
          <ul class="menu" id="menu">
            <li onclick="
                    document.getElementById('modal').style.display = 'flex';
                    document.getElementById('profile').style.display = 'flex';
                  ">
            Профиль компании
          </li>
            <li><a href="{% url 'provider_orders' %}" style="background-color: #090696;">Заказы в регионе</a></li>
            <li><a href="{% url 'provider_balance' %}" style="background-color: #090696;">Баланс</a></li>
            <li><a href="{% url 'provider_quantity' %}" style="background-color: #090696;">Отправлено КП</a></li>
            <li><a href="{% url 'provider_work' %}" style="background-color: #090696;">В работе</a></li>
            <li><a href="{% url 'provider_archive' %}" style="background-color: #090696;">Архив</a></li>
            <li><a href="" style="background-color: #090696;">Реклама</a></li>
            <li><a href="https://t.me/chattodotodo_bot?start=IGS-6Nn-twD17M6tfFgpg" style="background-color: #090696;">Помощь</a></li>
            <li><a href="{% url 'logout_core_view' %}" style="background-color: #090696;">Выход</a></li>
          </ul>
        </div>
      </aside>
      <div class="popup" id="popup"></div>
      <div class="view">
        <div class="content">
          <div class="split center">
            <form>
              <h2 style="white-space: nowrap;" class="title">Опыт: {{ order.user.practice }}</h2>
              <br>
              {% if order.type_delivery == '0' %}
              <h3 class="title">Адрес: {{ order.address }}</h3>
              {% elif order.type_delivery == '1' %}
              <h3 class="title">Адрес: {{ order.user.warehouse_address }}</h3>
              {% else %}
              <h3 class="title">Адрес: Самовывоз</h3>
              {% endif %}
            </form>
          </div>
          <div class="split">
            <form method="post" action="{% url 'provider_response' order.id %}" enctype="multipart/form-data" id="send_diler">
              {% csrf_token %}
              <table class="table" cellspacing="0" cellpadding="0">
                <thead>
                  <tr>
                    <th style="background-color: #090696;">Дата</th>
                    <th style="background-color: #403ec2;">Профиль</th>
                    <th style="background-color: #090696;">Фурнитура</th>
                    <th style="background-color: #403ec2;">Оплата</th>
                    <th style="background-color: #090696;">Доставка</th>
                    <th style="white-space: nowrap; background-color: #403ec2;">Дата поставки</th>
                    <th style="background-color: #090696;">Профиль</th>
                    <th style="background-color: #403ec2;">Фурнитура</th>
                    <th style="background-color: #090696;">Стоимость</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td style="white-space: nowrap;">{{ order.date|date:'d.m.Y' }}</td>
                    <td style="white-space: nowrap;">{{ order.shape.data }}</td>
                    <td style="white-space: nowrap;">{{ order.implement.data }}</td>
                    {% if order.type_pay == 'C' %}
                    <td>Карта</td>
                    {% else %}
                    <td>Безнал</td>
                    {% endif %}

                    {% if order.type_delivery == '0' %}
                    <td style="white-space: nowrap;">Адрес клиента</td>
                    {% elif order.type_delivery == '1' %}
                    <td style="white-space: nowrap;">Мой склад</td>
                    {% else %}
                    <td>Самовывоз</td>
                    {% endif %}
                    <td>
                      <input type="date" name="date" style="width: 100%; background-color: #efefef;
                      border: none;
                      border-radius: 1em;">
                    </td>
                    <td>
                      <select name="shape" class="sel" style="width: 100%;
                          border: none;
                          border-radius: 1em;">
                        <option value="" disabled selected>Профиль</option>
                        {% for shape in profile.provider.shapes.all %}
                          <option value="{{ shape.id }}">{{ shape.data }}</option>
                        {% endfor %}
                      </select>
                    </td>
                    <td>
                      <select name="implement" class="sel" style="width: 100%;
                          border: none;
                          border-radius: 1em;">
                        <option value="" disabled selected>Фурнитура</option>
                        {% for implement in profile.provider.implements.all %}
                          <option value="{{ implement.id }}">{{ implement.data }}</option>
                        {% endfor %}
                      </select>
                    </td>
                    <td>
                      <input type="number" placeholder="0,00" name="price" style="width: 100%; background-color: #efefef;
                      border: none;
                      border-radius: 1em;">
                    </td>
                  </tr>
                </tbody>
              </table>
              <div class="fields">
                <div class="drag_field">
                  <p>Прикрепленные файлы</p>
                  <div class="files">
                    <div>
                      <a href="{{ order.file.url }}" style="text-decoration: none;">{{ order.filename }}</a>
                    </div>
                   
                  </div>
                </div>
                <div class="drag_field">
                  <p>{{ order.comment }}</p>
                </div>
              </div>
              <br>
              <input type="text" class="drag_field" name="comment">
              <div class="grid_ui">
                  <div class="input-file-row">
                    <label class="input-file">
                         <input type="file" name="upload" accept=".pdf">		
                         <span>Прикрепить КП</span>
                     </label>
                    <div class="input-file-list"></div>  
                  </div>
                <button style="white-space: nowrap;" class="send_diler" type="button">Отправить дилеру</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="modal" id="modal">
      <form class="window" id="profile" method="post" action="{% url 'provider_profile' %}" enctype="multipart/form-data" style="background-color: #090696;">
        {% csrf_token %}
        <span onclick="
              document.getElementById('modal').style.display = 'none';
              document.getElementById('profile').style.display = 'none';
            " class="close_button">&times;</span>
        <div class="profile_picture flex_center">
          <div class="branding">
            <label class="logo" id="logo_preview" for="logo_upload" {% if profile.provider.logo %} style="background: url('{{ profile.provider.logo.url }}') 0 0/100% 100% no-repeat; border-radius: 50%;" {% else %} style="border-radius: 50%;" {% endif %}>
              {% if profile.provider.logo %}
              {% else %}
              <p>Ваше лого</p>
              {% endif %}
            </label>
            <input
              type="file"
              accept="image/*"
              name="logo"
              id="logo_upload"
              style="display: none"
            />
          </div>
        </div>
        <div class="inputs_with_label">
          <div>
            <p>Название компании</p>
            <input type="text" value="{{ profile.provider.company }}" name="company"/>
          </div>
          <div>
            <p>Юридическое лицо</p>
            <input type="text" value="{{ profile.provider.legal_entity }}" name="legal_entity"/>
          </div>
          <div>
            <p>Адрес производства</p>
            <input type="text" value="{{ profile.provider.product_address }}" name="product_address"/>
          </div>
          <div>
            <p>Руководитель</p>
            <input type="text" value="{{ profile.provider.contact_entity }}" name="contact_entity"/>
          </div>
          <div>
            <p>Телефон производства</p>
            <input type="text" value="{{ profile.provider.contact_phone }}" name="contact_phone"/>
          </div>
          <div>
            <p>Менеджер</p>
            <input type="text" value="{{ profile.provider.service_entity }}" name="service_entity"/>
          </div>
          <div>
            <p>Контактный телефон</p>
            <input type="text" value="{{ profile.provider.service_phone }}" name="service_phone"/>
          </div>
          <div>
            <p>E-mail</p>
            <input type="text" value="{{ profile.provider.service_email }}" name="service_email"/>
          </div>
          <div>
            <p>Профили</p>
            <select multiple="multiple" class="select" style="width: 100%;" name="shapes">
              {% for shape in shapes %}
                  <option value="{{ shape.id }}" {% if shape in profile.provider.shapes.all %} selected {% endif %}>{{ shape.data }}</option>
                {% endfor %}
            </select>
          </div>
          <div>
            <p>Фурнитура</p>
            <select multiple="multiple" class="select" style="width: 100%;" name="implements">
              {% for implement in implements %}
                  <option value="{{ implement.id }}" {% if implement in profile.provider.implements.all %} selected {% endif %}>{{ implement.data }}</option>
                {% endfor %}
            </select>
          </div>
          <div>
            <p>Области доставки</p>
            <select multiple="multiple" class="select" style="width: 100%;" name="regions">
              {% for region in regions %}
                  <option value="{{ region.id }}" {% if region in profile.provider.regions.all %} selected {% endif %}>{{ region.data }}</option>
                {% endfor %}
            </select>
          </div>
          <br>
          <div style="display: flex;">
            <input type="checkbox" name="submitemail" id="" {% if profile.provider.isEmailsubmit %} checked {% endif %}/>
            <a style="padding-left: 5px; color: white;">Подписка на рассылку</a>
          </div>
          <br>
          <textarea
                  class="brand_description smaller"
                  name="description"
                  placeholder="О компании"
                  id=""
                  rows="10"
                >{{ profile.provider.description }}</textarea>
        </div>
        <div class="flex_center">
          <button id="send_profile" style="background-color: #07995c;" type="button">Подтвердить</button>
        </div>
      </form>
      </div>
      <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
      <script src="https://unpkg.com/multiple-select@1.5.2/dist/multiple-select.min.js"></script>
      <script>
        $(function () {
          $('.select').multipleSelect()
        })
      </script>
      <script>
        const logoInput = document.getElementById("logo_upload");
        const logoPreview = document.getElementById("logo_preview");
        logoInput.onchange = (e) => {
          const [file] = logoInput.files;
          if (file) {
            logoPreview.style.background =
              "url(" + URL.createObjectURL(file) + ") 0 0/100% 100% no-repeat";
            logoPreview.innerHTML = "";
          }
        };
        
        let btn = document.querySelector('#send_profile')
        btn.addEventListener('click',function(){
          let company = document.querySelector('input[name$="company"]');
          let legal_entity = document.querySelector('input[name$="legal_entity"]');
          let product_address = document.querySelector('input[name$="product_address"]');
          let contact_entity = document.querySelector('input[name$="contact_entity"]');
          let contact_phone = document.querySelector('input[name$="contact_phone"]');
          let service_entity = document.querySelector('input[name$="service_entity"]');
          let service_phone = document.querySelector('input[name$="service_phone"]');
          let service_email = document.querySelector('input[name$="service_email"]');
          let description = document.querySelector('textarea[name$="description"]');
          if (company.value == '' || legal_entity.value == '' || product_address.value == '' || contact_entity.value == '' || contact_phone.value == '' || service_entity.value == '' || service_phone.value == '' || service_email.value == '' || description.value == ''){
            alert('Заполните все поля')
          }
          else {
            let f = document.querySelector('#profile')
            f.submit()
          }
        })
  
        const hamb = document.querySelector("#hamb");
        const popup = document.querySelector("#popup");
        const body = document.body;
  
        const menu = document.querySelector("#menu").cloneNode(1);
  
        hamb.addEventListener("click", hambHandler);
  
        function hambHandler(e) {
          e.preventDefault();
          popup.classList.toggle("open");
          hamb.classList.toggle("active");
          body.classList.toggle("noscroll");
          renderPopup();
        }
  
        function renderPopup() {
          popup.appendChild(menu);
        }
  
        const links = Array.from(menu.children);
  
        links.forEach((link) => {
          link.addEventListener("click", closeOnClick);
        });
  
        function closeOnClick() {
          popup.classList.remove("open");
          hamb.classList.remove("active");
          body.classList.remove("noscroll");
        }
      </script>
    <script>
      var dt = new DataTransfer();
  
      $('.input-file input[type=file]').on('change', function(){
        let $files_list = $(this).closest('.input-file').next();
        $files_list.empty();
        
        for(var i = 0; i < this.files.length; i++){
          let file = this.files.item(i);
          dt.items.add(file);    
          
          let reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onloadend = function(){
            let new_file_input = '<div class="input-file-list-item">' +
              '<span class="input-file-list-name">' + file.name + '</span>' +
              '<a href="#" onclick="removeFilesItem(this); return false;" class="input-file-list-remove">x</a>' +
            '</div>';
            $files_list.append(new_file_input); 
          }
        };
        this.files = dt.files;
      });
        
      function removeFilesItem(target){
        let name = $(target).prev().text();
        let input = $(target).closest('.input-file-row').find('input[type=file]');	
        $(target).closest('.input-file-list-item').remove();	
        for(let i = 0; i < dt.items.length; i++){
          if(name === dt.items[i].getAsFile().name){
            dt.items.remove(i);
          }
        }
        input[0].files = dt.files;  
      }
      const btnd = document.querySelector('.send_diler')
      btnd.addEventListener('click', function(){
        let date = document.querySelector('input[name$="date"]');
        let shape = document.querySelector('select[name$="shape"]');
        let implement = document.querySelector('select[name$="implement"]');
        let price = document.querySelector('input[name$="price"]');
        let upload = document.querySelector('input[name$="upload"]');
        if (date.value == '' || shape.value == '' || implement.value == '' || price.value == '' || upload.value == ''){
          alert('Заполните все поля')
        } else {
          f = document.querySelector('#send_diler')
          f.submit()
        }
      })
      
  </script>
  </body>
</html>
